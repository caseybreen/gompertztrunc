<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="gompertztrunc">
<title>Analyzing doubly-truncated mortality data using the gompertztrunc package • gompertztrunc</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.0/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.0/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Analyzing doubly-truncated mortality data using the gompertztrunc package">
<meta property="og:description" content="gompertztrunc">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">gompertztrunc</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/gompertztrunc_vignette.html">Analyzing doubly-truncated mortality data using the gompertztrunc package</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">



<script src="gompertztrunc_vignette_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <main id="main"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Analyzing doubly-truncated mortality data using the gompertztrunc package</h1>
                        <h4 data-toc-skip class="author">Casey Breen (<a href="mailto:caseybreen@berkeley.edu" class="email">caseybreen@berkeley.edu</a>)</h4>
            
      
      
      <div class="d-none name"><code>gompertztrunc_vignette.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="summary">Summary<a class="anchor" aria-label="anchor" href="#summary"></a>
</h2>
<p>This vignette gives an overview of the <code>gompertztrunc</code> package and presents three case-studies illustrating the package’s functionality. The goal of this vignette is to give users a high-level overview of using the <code>gompertztrunc</code> package for mortality estimation including the use of weights, the specification and visualization of models, and limitations of this approach.</p>
</div>
<div class="section level2">
<h2 id="background">Background<a class="anchor" aria-label="anchor" href="#background"></a>
</h2>
<p>Researchers increasingly have access to administrative mortality records that only include those who have died for a limited observation window without information on survivors. The double truncation and absence of denominators precludes the use of conventional tools of survival analysis. The <strong>gompertztrunc</strong> package includes tools for mortality estimation of doubly-truncated datasets without population denominators.</p>
</div>
<div class="section level2">
<h2 id="summary-of-parametric-gompertz-approach">Summary of Parametric Gompertz Approach<a class="anchor" aria-label="anchor" href="#summary-of-parametric-gompertz-approach"></a>
</h2>
<p>This method assumes mortality follows a parametric Gompertz proportional-hazard model and uses maximum likelihood methods to estimate the parameters of this mortality distribution. Specifically, the hazard for individual <span class="math inline">\(i\)</span> at age <span class="math inline">\(x\)</span> given parameters <span class="math inline">\(\beta\)</span> is given by</p>
<p><span class="math display">\[h_i(x | \beta) = a_0 e^{b_0 x} e^{\beta Z_i}\]</span> where</p>
<ul>
<li>
<span class="math inline">\(h(x)\)</span> is the hazard at age <span class="math inline">\(x\)</span>
</li>
<li>
<span class="math inline">\(a_0\)</span> is some baseline level of mortality</li>
<li>
<span class="math inline">\(b_0\)</span> gives rate of increase of mortality</li>
<li>
<span class="math inline">\(Z_i\)</span> are the covariates for person <span class="math inline">\(i\)</span> (e.g., years of education, place of birth)</li>
<li>
<span class="math inline">\(\beta\)</span> is the set of parameters</li>
</ul>
<p>The model will estimate the values of <span class="math inline">\(\widehat{a}\)</span>, <span class="math inline">\(\widehat{b}\)</span>, and <span class="math inline">\(\widehat{\beta}\)</span>.</p>
<p>The main function in the package is the <code><a href="../reference/gompertz_mle.html">gompertztrunc::gompertz_mle</a></code> function, which takes the following main arguments:</p>
<ul>
<li><p><code>formula</code>: model formula (for example, death_age ~ educ_yrs + homeownership)</p></li>
<li><p><code>left_trunc</code>: year of upper truncation</p></li>
<li><p><code>right_trunc</code>: year of lower truncation</p></li>
<li><p><code>data</code>: data frame with age of death variable and covariates</p></li>
<li><p><code>byear</code>: year of birth</p></li>
<li><p><code>maxiter</code>: maximum number of iteration for <a href="https://www.rdocumentation.org/packages/stats/versions/3.6.2/topics/optim" class="external-link">optim</a> function</p></li>
<li><p><code>weights</code>: an optional vector of person-level weights</p></li>
</ul>
</div>
<div class="section level2">
<h2 id="setup">Setup<a class="anchor" aria-label="anchor" href="#setup"></a>
</h2>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## library packages</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://caseybreen.github.io/gompertztrunc">gompertztrunc</a></span><span class="op">)</span>         <span class="co">## calculate mortality differentials under double-truncation  </span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span>             <span class="co">## data manipulation and visualization  </span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com" class="external-link">data.table</a></span><span class="op">)</span>            <span class="co">## fast data manipulation</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://wilkelab.org/cowplot/" class="external-link">cowplot</a></span><span class="op">)</span>               <span class="co">## publication-ready themes for ggplot</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://kjhealy.github.io/socviz/" class="external-link">socviz</a></span><span class="op">)</span>                <span class="co">## helper functions for data visualization (Kieran Healy)  </span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://broom.tidymodels.org/" class="external-link">broom</a></span><span class="op">)</span>                 <span class="co">## "tidy" model output </span>


<span class="co">## load data </span>
<span class="va">sim_data</span> <span class="op">&lt;-</span> <span class="va">sim_data</span>             <span class="co">## simulated </span>
<span class="va">bunmd_demo</span> <span class="op">&lt;-</span> <span class="va">bunmd_demo</span>         <span class="co">## real </span>
<span class="va">numident_demo</span> <span class="op">&lt;-</span> <span class="fu">gompertztrunc</span><span class="fu">::</span><span class="va"><a href="../reference/numident_demo.html">numident_demo</a></span>   <span class="co">## real </span></code></pre></div>
</div>
<div class="section level2">
<h2 id="case-study-i-simulated-data">Case Study I: Simulated Data<a class="anchor" aria-label="anchor" href="#case-study-i-simulated-data"></a>
</h2>
<p>In our first case study, we use simulated (fake) data included in the gompertztrunc package. Because we simulated the data, we know the true coefficient values (we also know that the mortality follows a Gompertz distribution and our proportional hazards assumption holds).</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## Look at simulated data </span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">sim_data</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">##    aod byear dyear       temp sex isSouth</span>
<span class="co">## 1:  87  1810  1897 -4.6198501   1       0</span>
<span class="co">## 2:  78  1810  1888 -0.8841613   1       0</span>
<span class="co">## 3:  79  1810  1890  0.7566703   1       0</span>
<span class="co">## 4:  85  1810  1895 -0.6728037   1       0</span>
<span class="co">## 5:  85  1810  1896 -3.8537981   1       0</span>
<span class="co">## 6:  81  1810  1891 -1.2885393   1       0</span></code></pre>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## What years do we have mortality coverage? </span>
<span class="va">sim_data</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">dyear</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">dyear</span><span class="op">)</span><span class="op">)</span> </code></pre></div>
<pre><code><span class="co">##   min(dyear) max(dyear)</span>
<span class="co">## 1       1888       1905</span></code></pre>
<p>Now let’s try running <code><a href="../reference/gompertz_mle.html">gompertz_mle()</a></code> function on the simulated data:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## run gompertz_mle function  </span>
<span class="co">## returns a list </span>
<span class="va">simulated_example</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/gompertz_mle.html">gompertz_mle</a></span><span class="op">(</span>formula <span class="op">=</span> <span class="va">aod</span> <span class="op">~</span> <span class="va">temp</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">sex</span><span class="op">)</span> <span class="op">+</span> <span class="va">isSouth</span>,
                                                 left_trunc <span class="op">=</span> <span class="fl">1888</span>,
                                                 right_trunc <span class="op">=</span> <span class="fl">1905</span>,
                                                 data <span class="op">=</span> <span class="va">sim_data</span><span class="op">)</span></code></pre></div>
<p>The <code><a href="../reference/gompertz_mle.html">gompertz_mle()</a></code> function returns a list which contains three elements:</p>
<ol style="list-style-type: decimal">
<li><p>The initial starting parameters for the MLE routine. These starting parameter are found using OLS regression on age at death</p></li>
<li><p>The full <code>optim</code> object, which gives details of the optimization routine (e.g., whether the model converged)</p></li>
<li><p>A data.frame of containing results: the estimated Gompertz parameters, coefficients, and hazards ratios with 95% confidence intervals.</p></li>
</ol>
<p>We recommend always checking the full <code>optim</code> object to make sure the model has converged.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## 1. starting value for coefficients (from linear regression)</span>
<span class="va">simulated_example</span><span class="op">$</span><span class="va">starting_values</span></code></pre></div>
<pre><code><span class="co">##     log.b.start        b0.start            temp as.factor(sex)1         isSouth </span>
<span class="co">##     -2.30258509     -9.96897213      0.07505734     -0.18001387      0.22607193</span></code></pre>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## 2. optim fit object</span>
<span class="va">simulated_example</span><span class="op">$</span><span class="va">optim_fit</span></code></pre></div>
<pre><code><span class="co">## $par</span>
<span class="co">##     log.b.start        b0.start            temp as.factor(sex)1         isSouth </span>
<span class="co">##      -2.2745186      -9.4083999       0.2068584      -0.5300299       0.5983461 </span>
<span class="co">## </span>
<span class="co">## $value</span>
<span class="co">## [1] 17549.16</span>
<span class="co">## </span>
<span class="co">## $counts</span>
<span class="co">## function gradient </span>
<span class="co">##      886       NA </span>
<span class="co">## </span>
<span class="co">## $convergence</span>
<span class="co">## [1] 0</span>
<span class="co">## </span>
<span class="co">## $message</span>
<span class="co">## NULL</span>
<span class="co">## </span>
<span class="co">## $hessian</span>
<span class="co">##                 log.b.start  b0.start       temp as.factor(sex)1   isSouth</span>
<span class="co">## log.b.start       283845.66 35822.202 -36549.785       20205.368 14017.009</span>
<span class="co">## b0.start           35822.20  4536.154  -4552.676        2553.982  1783.017</span>
<span class="co">## temp              -36549.79 -4552.676  32378.684       -1569.926 -3199.463</span>
<span class="co">## as.factor(sex)1    20205.37  2553.982  -1569.926        2553.949  1109.978</span>
<span class="co">## isSouth            14017.01  1783.017  -3199.463        1109.978  1783.000</span></code></pre>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## 2. check model convergence (0 == convergence)</span>
<span class="va">simulated_example</span><span class="op">$</span><span class="va">optim_fit</span><span class="op">$</span><span class="va">convergence</span></code></pre></div>
<pre><code><span class="co">## [1] 0</span></code></pre>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## 3. Look at model results </span>
<span class="va">simulated_example</span><span class="op">$</span><span class="va">results</span></code></pre></div>
<pre><code><span class="co">## <span style="color: #949494;"># A tibble: 5 × 7</span></span>
<span class="co">##   parameter         coef coef_lower coef_upper     hr hr_lower hr_upper</span>
<span class="co">##   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>            <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span>
<span class="co">## <span style="color: #BCBCBC;">1</span> gompertz_b       0.103     0.096<span style="text-decoration: underline;">4</span>      0.110 <span style="color: #BB0000;">NA</span>       <span style="color: #BB0000;">NA</span>       <span style="color: #BB0000;">NA</span>    </span>
<span class="co">## <span style="color: #BCBCBC;">2</span> gompertz_mode   69.4      64.4        74.3   <span style="color: #BB0000;">NA</span>       <span style="color: #BB0000;">NA</span>       <span style="color: #BB0000;">NA</span>    </span>
<span class="co">## <span style="color: #BCBCBC;">3</span> temp             0.207     0.194       0.219  1.23     1.21     1.25 </span>
<span class="co">## <span style="color: #BCBCBC;">4</span> as.factor(sex)1 -<span style="color: #BB0000;">0.530</span>    -<span style="color: #BB0000;">0.590</span>      -<span style="color: #BB0000;">0.470</span>  0.589    0.554    0.625</span>
<span class="co">## <span style="color: #BCBCBC;">5</span> isSouth          0.598     0.536       0.661  1.82     1.71     1.94</span></code></pre>
<p>The first column gives the Gompertz <span class="math inline">\(b\)</span> parameter, and the second row gives the Gompertz mode. The next three rows show each covariate’s estimated coefficient and associate hazard ratio. A hazard ratio compares the ratio of the hazard rate in a population strata (e.g., treated group) to a population baseline (i.e., control group). A hazard ratio above 1 suggests a higher risk at all ages and a hazard ratio below 1 suggests a smaller mortality risk at all ages (assuming proportional hazards).</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## true coefficient values (we know bc we simulated them)</span>
<span class="va">mycoefs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"temp"</span> <span class="op">=</span> <span class="op">+</span><span class="fl">.2</span>, <span class="st">"sex"</span> <span class="op">=</span> <span class="op">-</span><span class="fl">.5</span>, <span class="st">"isSouth"</span> <span class="op">=</span> <span class="op">+</span><span class="fl">.6</span><span class="op">)</span>

<span class="co">## compare our estimated values to true value </span>
<span class="co">## we can only do this because this is simulated (fake) data </span>

<span class="va">simulated_example</span><span class="op">$</span><span class="va">results</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html" class="external-link">str_detect</a></span><span class="op">(</span><span class="va">parameter</span>, <span class="st">"gompertz"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>true_coef <span class="op">=</span> <span class="va">mycoefs</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">parameter</span>, <span class="va">coef</span>, <span class="va">coef_lower</span>, <span class="va">coef_upper</span>, <span class="va">true_coef</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## <span style="color: #949494;"># A tibble: 3 × 5</span></span>
<span class="co">##   parameter         coef coef_lower coef_upper true_coef</span>
<span class="co">##   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>            <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span>
<span class="co">## <span style="color: #BCBCBC;">1</span> temp             0.207      0.194      0.219       0.2</span>
<span class="co">## <span style="color: #BCBCBC;">2</span> as.factor(sex)1 -<span style="color: #BB0000;">0.530</span>     -<span style="color: #BB0000;">0.590</span>     -<span style="color: #BB0000;">0.470</span>      -<span style="color: #BB0000;">0.5</span></span>
<span class="co">## <span style="color: #BCBCBC;">3</span> isSouth          0.598      0.536      0.661       0.6</span></code></pre>
<p>While investigators will ultimately report hazard ratios, translating hazard ratios into differences in life expectancy may help facilitate interpretation and comparison to other studies. We have included this functionality in the gompertztrunc package:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## translate hazard rates to difference in e65</span>
<span class="fu"><a href="../reference/convert_hazards_to_ex.html">convert_hazards_to_ex</a></span><span class="op">(</span><span class="va">simulated_example</span><span class="op">$</span><span class="va">results</span>, age <span class="op">=</span> <span class="fl">65</span>, use_model_estimates <span class="op">=</span> <span class="cn">T</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">parameter</span>, <span class="va">hr</span>, <span class="va">hr_lower</span>, <span class="va">hr_upper</span>, <span class="va">e65</span>, <span class="va">e65_lower</span>, <span class="va">e65_upper</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## <span style="color: #949494;"># A tibble: 3 × 7</span></span>
<span class="co">##   parameter          hr hr_lower hr_upper    e65 e65_lower e65_upper</span>
<span class="co">##   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>           <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span>
<span class="co">## <span style="color: #BCBCBC;">1</span> temp            1.23     1.21     1.25  -<span style="color: #BB0000;">0.966</span>     -<span style="color: #BB0000;">1.02</span>    -<span style="color: #BB0000;">0.910</span></span>
<span class="co">## <span style="color: #BCBCBC;">2</span> as.factor(sex)1 0.589    0.554    0.625  2.84       2.49     3.20 </span>
<span class="co">## <span style="color: #BCBCBC;">3</span> isSouth         1.82     1.71     1.94  -<span style="color: #BB0000;">2.57</span>      -<span style="color: #BB0000;">2.80</span>    -<span style="color: #BB0000;">2.33</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="case-study-ii-real-world-example-with-bunmd-data">Case Study II: Real-World Example with BUNMD Data<a class="anchor" aria-label="anchor" href="#case-study-ii-real-world-example-with-bunmd-data"></a>
</h2>
<p>In our second case study, we look at the mortality advantage for the foreign-born. We use a demo dataset from the Berkeley Unified Numident Mortality Database (BUNMD).</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## look at data </span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">bunmd_demo</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## <span style="color: #949494;"># A tibble: 6 × 6</span></span>
<span class="co">##         ssn bpl_string death_age byear dyear age_first_application</span>
<span class="co">##       <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>                 <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span>
<span class="co">## <span style="color: #BCBCBC;">1</span> 267<span style="text-decoration: underline;">729</span>143 Cuba              89  <span style="text-decoration: underline;">1</span>912  <span style="text-decoration: underline;">2</span>002                    49</span>
<span class="co">## <span style="color: #BCBCBC;">2</span> 266<span style="text-decoration: underline;">172</span>087 Cuba              80  <span style="text-decoration: underline;">1</span>911  <span style="text-decoration: underline;">1</span>991                    57</span>
<span class="co">## <span style="color: #BCBCBC;">3</span> 590<span style="text-decoration: underline;">072</span>321 Cuba              92  <span style="text-decoration: underline;">1</span>911  <span style="text-decoration: underline;">2</span>004                    69</span>
<span class="co">## <span style="color: #BCBCBC;">4</span> 265<span style="text-decoration: underline;">064</span>566 Cuba              76  <span style="text-decoration: underline;">1</span>913  <span style="text-decoration: underline;">1</span>989                    53</span>
<span class="co">## <span style="color: #BCBCBC;">5</span> 265<span style="text-decoration: underline;">877</span>097 Cuba              86  <span style="text-decoration: underline;">1</span>908  <span style="text-decoration: underline;">1</span>995                    70</span>
<span class="co">## <span style="color: #BCBCBC;">6</span> 264<span style="text-decoration: underline;">745</span>485 Cuba              87  <span style="text-decoration: underline;">1</span>915  <span style="text-decoration: underline;">2</span>003                    46</span></code></pre>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## how many people per country? </span>
<span class="va">bunmd_demo</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html" class="external-link">count</a></span><span class="op">(</span><span class="va">bpl_string</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## <span style="color: #949494;"># A tibble: 6 × 2</span></span>
<span class="co">##   bpl_string            n</span>
<span class="co">##   <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>             <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span>
<span class="co">## <span style="color: #BCBCBC;">1</span> Native Born White <span style="text-decoration: underline;">20</span>000</span>
<span class="co">## <span style="color: #BCBCBC;">2</span> Cuba              <span style="text-decoration: underline;">13</span>194</span>
<span class="co">## <span style="color: #BCBCBC;">3</span> England            <span style="text-decoration: underline;">7</span>561</span>
<span class="co">## <span style="color: #BCBCBC;">4</span> Italy             <span style="text-decoration: underline;">15</span>306</span>
<span class="co">## <span style="color: #BCBCBC;">5</span> Mexico            <span style="text-decoration: underline;">13</span>755</span>
<span class="co">## <span style="color: #BCBCBC;">6</span> Poland            <span style="text-decoration: underline;">11</span>186</span></code></pre>
<p>First, let’s look at the distribution of deaths by country:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## distribution of deaths?</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">bunmd_demo</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html" class="external-link">geom_histogram</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">death_age</span><span class="op">)</span>,
                 fill <span class="op">=</span> <span class="st">"grey"</span>,
                 color <span class="op">=</span> <span class="st">"black"</span>,
                 binwidth <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">cowplot</span><span class="fu">::</span><span class="fu"><a href="https://wilkelab.org/cowplot/reference/theme_cowplot.html" class="external-link">theme_cowplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Age of Death"</span>,
       y <span class="op">=</span> <span class="st">"N"</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">bpl_string</span><span class="op">)</span></code></pre></div>
<p><img src="gompertztrunc_vignette_files/figure-html/unnamed-chunk-8-1.png" width="576"></p>
<div class="section level3">
<h3 id="linear-regression-approach">Linear regression approach<a class="anchor" aria-label="anchor" href="#linear-regression-approach"></a>
</h3>
<p>Let’s look at the association between country of origin and longevity. First, we’ll try using a biased approach (OLS regression on age of death).</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## run linear model </span>
<span class="va">lm_bpl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">death_age</span> <span class="op">~</span> <span class="va">bpl_string</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">byear</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">bunmd_demo</span><span class="op">)</span>

<span class="co">## extract coefficients from model </span>
<span class="va">lm_bpl_tidy</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html" class="external-link">tidy</a></span><span class="op">(</span><span class="va">lm_bpl</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html" class="external-link">str_detect</a></span><span class="op">(</span><span class="va">term</span>, <span class="st">"bpl_string"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>term <span class="op">=</span> <span class="fu"><a href="http://kjhealy.github.io/socviz/reference/prefix_strip.html" class="external-link">prefix_strip</a></span><span class="op">(</span><span class="va">term</span>, <span class="st">"bpl_string"</span><span class="op">)</span><span class="op">)</span>

<span class="co">## rename variables </span>
<span class="va">lm_bpl_tidy</span> <span class="op">&lt;-</span> <span class="va">lm_bpl_tidy</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>
    e65 <span class="op">=</span> <span class="va">estimate</span>,
    e65_lower <span class="op">=</span> <span class="va">estimate</span> <span class="op">-</span> <span class="fl">1.96</span> <span class="op">*</span> <span class="va">std.error</span>,
    e65_upper <span class="op">=</span> <span class="va">estimate</span> <span class="op">+</span> <span class="fl">1.96</span> <span class="op">*</span> <span class="va">std.error</span>
  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>country <span class="op">=</span> <span class="va">term</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"Regression on Age of Death"</span><span class="op">)</span></code></pre></div>
<p>Now we’ll perform estimation with the <code>gompertztrunc</code> package:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## Gompertz Trunc </span>
<span class="co">## Use 1988-2005 because we are using BUNMD </span>
<span class="va">gompert_mle_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/gompertz_mle.html">gompertz_mle</a></span><span class="op">(</span>formula <span class="op">=</span> <span class="va">death_age</span> <span class="op">~</span> <span class="va">bpl_string</span>, 
                                    left_trunc <span class="op">=</span> <span class="fl">1988</span>,
                                    right_trunc <span class="op">=</span> <span class="fl">2005</span>,
                                    data <span class="op">=</span> <span class="va">bunmd_demo</span><span class="op">)</span>

<span class="co">## convert to e65</span>
<span class="co">## use model estimates — but can also set other defaults for Gompertz M and B. </span>
<span class="va">mle_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/convert_hazards_to_ex.html">convert_hazards_to_ex</a></span><span class="op">(</span><span class="va">gompert_mle_results</span><span class="op">$</span><span class="va">results</span>, use_model_estimates <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>

<span class="co">## tidy up results </span>
<span class="va">mle_results</span> <span class="op">&lt;-</span> <span class="va">mle_results</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>country <span class="op">=</span> <span class="va">parameter</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html" class="external-link">str_detect</a></span><span class="op">(</span><span class="va">country</span>, <span class="st">"bpl_string"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>country <span class="op">=</span> <span class="fu"><a href="http://kjhealy.github.io/socviz/reference/prefix_strip.html" class="external-link">prefix_strip</a></span><span class="op">(</span><span class="va">country</span>, <span class="st">"bpl_string"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"Gompertz Parametric Estimate"</span><span class="op">)</span>

<span class="co">## look at results </span>
<span class="va">mle_results</span></code></pre></div>
<pre><code><span class="co">## <span style="color: #949494;"># A tibble: 5 × 11</span></span>
<span class="co">##   country   coef coef_lower coef_upper    hr hr_lower hr_upper   e65 e65_lower</span>
<span class="co">##   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span>
<span class="co">## <span style="color: #BCBCBC;">1</span> Cuba    -<span style="color: #BB0000;">0.229</span>     -<span style="color: #BB0000;">0.270</span>    -<span style="color: #BB0000;">0.188</span>  0.796    0.764    0.829 1.70      1.39 </span>
<span class="co">## <span style="color: #BCBCBC;">2</span> England -<span style="color: #BB0000;">0.130</span>     -<span style="color: #BB0000;">0.179</span>    -<span style="color: #BB0000;">0.081</span><span style="color: #BB0000; text-decoration: underline;">5</span> 0.878    0.836    0.922 0.960     0.597</span>
<span class="co">## <span style="color: #BCBCBC;">3</span> Italy   -<span style="color: #BB0000;">0.178</span>     -<span style="color: #BB0000;">0.217</span>    -<span style="color: #BB0000;">0.138</span>  0.837    0.805    0.871 1.31      1.02 </span>
<span class="co">## <span style="color: #BCBCBC;">4</span> Mexico  -<span style="color: #BB0000;">0.369</span>     -<span style="color: #BB0000;">0.412</span>    -<span style="color: #BB0000;">0.325</span>  0.692    0.662    0.723 2.77      2.44 </span>
<span class="co">## <span style="color: #BCBCBC;">5</span> Poland  -<span style="color: #BB0000;">0.185</span>     -<span style="color: #BB0000;">0.229</span>    -<span style="color: #BB0000;">0.141</span>  0.831    0.795    0.869 1.37      1.04 </span>
<span class="co">## <span style="color: #949494;"># … with 2 more variables: e65_upper &lt;dbl&gt;, method &lt;chr&gt;</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="visualize-results">Visualize Results<a class="anchor" aria-label="anchor" href="#visualize-results"></a>
</h3>
<p>Here, we compare our estimates from ‘unbiased’ Gompertz MLE method and our old ‘biased’ method, regression on age of death.</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## combine results from both models </span>
<span class="va">bpl_results</span> <span class="op">&lt;-</span> <span class="va">lm_bpl_tidy</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">mle_results</span><span class="op">)</span>

<span class="co">## Calculate adjustment factor (i.e., how much bigger are Gompertz MLE results)</span>
<span class="va">adjustment_factor</span> <span class="op">&lt;-</span> <span class="va">bpl_results</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">country</span>, <span class="va">method</span>, <span class="va">e65</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html" class="external-link">pivot_wider</a></span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">method</span>, values_from <span class="op">=</span> <span class="va">e65</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>adjustment_factor <span class="op">=</span> <span class="va">`Gompertz Parametric Estimate`</span> <span class="op">/</span> <span class="va">`Regression on Age of Death`</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span>adjustment_factor_mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">adjustment_factor</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="op">)</span>

<span class="co">## Plot results</span>
<span class="va">bpl_results</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">mle_results</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/reorder.factor.html" class="external-link">reorder</a></span><span class="op">(</span><span class="va">country</span>, <span class="va">e65</span><span class="op">)</span>, x <span class="op">=</span> <span class="va">e65</span>, xmin <span class="op">=</span> <span class="va">e65_lower</span>, xmax <span class="op">=</span> <span class="va">e65_upper</span>, color <span class="op">=</span> <span class="va">method</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_linerange.html" class="external-link">geom_pointrange</a></span><span class="op">(</span>position <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/position_dodge.html" class="external-link">position_dodge</a></span><span class="op">(</span>width <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span>, shape <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">cowplot</span><span class="fu">::</span><span class="fu"><a href="https://wilkelab.org/cowplot/reference/theme_cowplot.html" class="external-link">theme_cowplot</a></span><span class="op">(</span>font_size <span class="op">=</span> <span class="fl">12</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">0</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span>, legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>
    x <span class="op">=</span> <span class="st">"Estimate"</span>,
    title <span class="op">=</span> <span class="st">"Foreign-Born Male Ages at Death, BUNMD 1905-1914"</span>,
    y <span class="op">=</span> <span class="st">""</span>,
    subtitle <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Gompertz MLE estimates are ~"</span>, <span class="va">adjustment_factor</span>, <span class="st">" times larger than regression on age of death"</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html" class="external-link">scale_color_brewer</a></span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"Set1"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html" class="external-link">annotate</a></span><span class="op">(</span><span class="st">"text"</span>, label <span class="op">=</span> <span class="st">"Native Born Whites"</span>, x <span class="op">=</span> <span class="fl">0.1</span>, y <span class="op">=</span> <span class="fl">3</span>, angle <span class="op">=</span> <span class="fl">90</span>, size <span class="op">=</span> <span class="fl">3</span>, color <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span></code></pre></div>
<p><img src="gompertztrunc_vignette_files/figure-html/unnamed-chunk-11-1.png" width="691.2"></p>
</div>
</div>
<div class="section level2">
<h2 id="case-study-iii-education-and-longevity-analysis-with-person-weights">Case Study III: Education and longevity analysis with person-weights<a class="anchor" aria-label="anchor" href="#case-study-iii-education-and-longevity-analysis-with-person-weights"></a>
</h2>
<p>In our third case study, we look at the association between education and longevity. We’ll use a pre-linked “demo” version of the CenSoc-Numident file, which contains 63 thousand mortality records and 20 mortality covariates from the 1940 census (~1% of the complete CenSoc-Numident dataset). We’ll also incorporate person-level weights into our analysis.</p>
<div class="section level3">
<h3 id="person-weights">Person-weights<a class="anchor" aria-label="anchor" href="#person-weights"></a>
</h3>
<p>The <code><a href="../reference/gompertz_mle.html">gompertz_mle()</a></code> function can incorporate person-level weights via the <code>weights</code> argument. These person weights can help adjust for differential representation; the weight assigned to each person is proportional to the estimated number of persons in the target population that person represents. The vector of supplied weights must be long as the data, and all weights must be positive.</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## load in file </span>
<span class="va">numident_demo</span> <span class="op">&lt;-</span> <span class="va">numident_demo</span>

<span class="co">## recode categorical education variable to continuous "years of education" </span>
<span class="va">numident_demo</span> <span class="op">&lt;-</span> <span class="va">numident_demo</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>educ_yrs <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span>
    <span class="va">educd</span> <span class="op">==</span> <span class="st">"No schooling completed"</span> <span class="op">~</span> <span class="fl">0</span>,
    <span class="va">educd</span> <span class="op">==</span> <span class="st">"Grade 1"</span> <span class="op">~</span> <span class="fl">1</span>,
    <span class="va">educd</span> <span class="op">==</span> <span class="st">"Grade 2"</span> <span class="op">~</span> <span class="fl">2</span>,
    <span class="va">educd</span> <span class="op">==</span> <span class="st">"Grade 3"</span> <span class="op">~</span> <span class="fl">3</span>,
    <span class="va">educd</span> <span class="op">==</span> <span class="st">"Grade 4"</span> <span class="op">~</span> <span class="fl">4</span>,
    <span class="va">educd</span> <span class="op">==</span> <span class="st">"Grade 5"</span> <span class="op">~</span> <span class="fl">5</span>,
    <span class="va">educd</span> <span class="op">==</span> <span class="st">"Grade 6"</span> <span class="op">~</span> <span class="fl">6</span>,
    <span class="va">educd</span> <span class="op">==</span> <span class="st">"Grade 7"</span> <span class="op">~</span> <span class="fl">7</span>,
    <span class="va">educd</span> <span class="op">==</span> <span class="st">"Grade 8"</span> <span class="op">~</span> <span class="fl">8</span>,
    <span class="va">educd</span> <span class="op">==</span> <span class="st">"Grade 9"</span> <span class="op">~</span> <span class="fl">9</span>,
    <span class="va">educd</span> <span class="op">==</span> <span class="st">"Grade 10"</span> <span class="op">~</span> <span class="fl">10</span>,
    <span class="va">educd</span> <span class="op">==</span> <span class="st">"Grade 11"</span> <span class="op">~</span> <span class="fl">11</span>,
    <span class="va">educd</span> <span class="op">==</span> <span class="st">"Grade 12"</span> <span class="op">~</span> <span class="fl">12</span>,
    <span class="va">educd</span> <span class="op">==</span> <span class="st">"Grade 12"</span> <span class="op">~</span> <span class="fl">12</span>,
    <span class="va">educd</span> <span class="op">==</span> <span class="st">"1 year of college"</span> <span class="op">~</span> <span class="fl">13</span>,
    <span class="va">educd</span> <span class="op">==</span> <span class="st">"2 years of college"</span> <span class="op">~</span> <span class="fl">14</span>,
    <span class="va">educd</span> <span class="op">==</span> <span class="st">"3 years of college"</span> <span class="op">~</span> <span class="fl">15</span>,
    <span class="va">educd</span> <span class="op">==</span> <span class="st">"4 years of college"</span> <span class="op">~</span> <span class="fl">16</span>,
    <span class="va">educd</span> <span class="op">==</span> <span class="st">"5+ years of college"</span> <span class="op">~</span> <span class="fl">17</span>
  <span class="op">)</span><span class="op">)</span>

<span class="co">## restrict to men </span>
<span class="va">data_numident_men</span> <span class="op">&lt;-</span> <span class="va">numident_demo</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">sex</span> <span class="op">==</span> <span class="st">"Male"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">byear</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fl">1910</span><span class="op">:</span><span class="fl">1920</span> <span class="op">&amp;</span> <span class="va">death_age</span> <span class="op">&gt;</span> <span class="fl">65</span><span class="op">)</span></code></pre></div>
<p>What’s the association between a 1-year increase in education and life expectancy at 65 (e65)? For this analysis, we’ll use the person-level weights using the <code>weights</code> argument in the <code><a href="../reference/gompertz_mle.html">gompertz_mle()</a></code> function.</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## look at person-level weights </span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">data_numident_men</span><span class="op">$</span><span class="va">weight</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] 3.399339 3.507209 4.615740 4.092312 3.655178 7.781576</span></code></pre>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## run gompertz model with person weights</span>
<span class="va">education_gradient</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/gompertz_mle.html">gompertz_mle</a></span><span class="op">(</span>formula <span class="op">=</span> <span class="va">death_age</span> <span class="op">~</span> <span class="va">educ_yrs</span>, 
                                   data <span class="op">=</span> <span class="va">data_numident_men</span>,
                                   weights <span class="op">=</span> <span class="va">weight</span>, <span class="co">## specify person-level weights </span>
                                   left_trunc <span class="op">=</span> <span class="fl">1988</span>, 
                                   right_trunc <span class="op">=</span> <span class="fl">2005</span><span class="op">)</span>

<span class="co">## look at results </span>
<span class="va">education_gradient</span><span class="op">$</span><span class="va">results</span> </code></pre></div>
<pre><code><span class="co">## <span style="color: #949494;"># A tibble: 3 × 7</span></span>
<span class="co">##   parameter        coef coef_lower coef_upper     hr hr_lower hr_upper</span>
<span class="co">##   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>           <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span>
<span class="co">## <span style="color: #BCBCBC;">1</span> gompertz_b     0.079<span style="text-decoration: underline;">9</span>     0.073<span style="text-decoration: underline;">6</span>     0.086<span style="text-decoration: underline;">8</span> <span style="color: #BB0000;">NA</span>       <span style="color: #BB0000;">NA</span>       <span style="color: #BB0000;">NA</span>    </span>
<span class="co">## <span style="color: #BCBCBC;">2</span> gompertz_mode 73.9       67.2       80.5    <span style="color: #BB0000;">NA</span>       <span style="color: #BB0000;">NA</span>       <span style="color: #BB0000;">NA</span>    </span>
<span class="co">## <span style="color: #BCBCBC;">3</span> educ_yrs      -<span style="color: #BB0000;">0.047</span><span style="color: #BB0000; text-decoration: underline;">6</span>    -<span style="color: #BB0000;">0.060</span><span style="color: #BB0000; text-decoration: underline;">7</span>    -<span style="color: #BB0000;">0.034</span><span style="color: #BB0000; text-decoration: underline;">4</span>  0.954    0.941    0.966</span></code></pre>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## translate to e65</span>
<span class="va">mle_results_educ</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/convert_hazards_to_ex.html">convert_hazards_to_ex</a></span><span class="op">(</span><span class="va">education_gradient</span><span class="op">$</span><span class="va">results</span>, use_model_estimates <span class="op">=</span> <span class="cn">T</span>, age <span class="op">=</span> <span class="fl">65</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"Parametric Gompertz MLE"</span><span class="op">)</span>

<span class="co">## look at results</span>
<span class="va">mle_results_educ</span></code></pre></div>
<pre><code><span class="co">## <span style="color: #949494;"># A tibble: 1 × 11</span></span>
<span class="co">##   parameter    coef coef_lower coef_upper    hr hr_lower hr_upper   e65</span>
<span class="co">##   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span>
<span class="co">## <span style="color: #BCBCBC;">1</span> educ_yrs  -<span style="color: #BB0000;">0.047</span><span style="color: #BB0000; text-decoration: underline;">6</span>    -<span style="color: #BB0000;">0.060</span><span style="color: #BB0000; text-decoration: underline;">7</span>    -<span style="color: #BB0000;">0.034</span><span style="color: #BB0000; text-decoration: underline;">4</span> 0.954    0.941    0.966 0.330</span>
<span class="co">## <span style="color: #949494;"># … with 3 more variables: e65_lower &lt;dbl&gt;, e65_upper &lt;dbl&gt;, method &lt;chr&gt;</span></span></code></pre>
<p>Here, for every additional year of education, the hazard ratio falls by 4.6% — which corresponds to an additional 0.33 year increase in e(65).</p>
<p>Now, let’s compare to a conventional method: OLS regression on age of death.</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## run linear model </span>
<span class="va">lm_bpl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">death_age</span> <span class="op">~</span> <span class="va">educ_yrs</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">byear</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">data_numident_men</span>, weights <span class="op">=</span> <span class="va">weight</span><span class="op">)</span>

<span class="co">## extract coefficients from model </span>
<span class="va">lm_bpl_tidy</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html" class="external-link">tidy</a></span><span class="op">(</span><span class="va">lm_bpl</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html" class="external-link">str_detect</a></span><span class="op">(</span><span class="va">term</span>, <span class="st">"educ_yrs"</span><span class="op">)</span><span class="op">)</span>

<span class="co">## rename variables </span>
<span class="va">ols_results</span> <span class="op">&lt;-</span> <span class="va">lm_bpl_tidy</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>
    e65 <span class="op">=</span> <span class="va">estimate</span>,
    e65_lower <span class="op">=</span> <span class="va">estimate</span> <span class="op">-</span> <span class="fl">1.96</span> <span class="op">*</span> <span class="va">std.error</span>,
    e65_upper <span class="op">=</span> <span class="va">estimate</span> <span class="op">+</span> <span class="fl">1.96</span> <span class="op">*</span> <span class="va">std.error</span>
  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>parameter <span class="op">=</span> <span class="va">term</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"Regression on Age of Death"</span><span class="op">)</span>

<span class="co">## Plot results</span>
<span class="va">education_plot</span> <span class="op">&lt;-</span> <span class="va">ols_results</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">mle_results_educ</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>parameter <span class="op">=</span> <span class="st">"Education (Years) Regression Coefficient"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">method</span>, y <span class="op">=</span> <span class="va">e65</span>, ymin <span class="op">=</span> <span class="va">e65_lower</span>, ymax <span class="op">=</span> <span class="va">e65_upper</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_linerange.html" class="external-link">geom_pointrange</a></span><span class="op">(</span>position <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/position_dodge.html" class="external-link">position_dodge</a></span><span class="op">(</span>width <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span>, shape <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">cowplot</span><span class="fu">::</span><span class="fu"><a href="https://wilkelab.org/cowplot/reference/theme_cowplot.html" class="external-link">theme_cowplot</a></span><span class="op">(</span>font_size <span class="op">=</span> <span class="fl">12</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span>, legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>
    x <span class="op">=</span> <span class="st">""</span>,
    title <span class="op">=</span> <span class="st">"Association Education (Years) and Longevity"</span>,
    subtitle <span class="op">=</span> <span class="st">"Men, CenSoc-Numident 1910-1920"</span>,
    y <span class="op">=</span> <span class="st">""</span>
  <span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html" class="external-link">scale_color_brewer</a></span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"Set1"</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">ylim</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.5</span><span class="op">)</span> 

<span class="va">education_plot</span></code></pre></div>
<p><img src="gompertztrunc_vignette_files/figure-html/unnamed-chunk-14-1.png" width="691.2"></p>
</div>
</div>
<div class="section level2">
<h2 id="summary-and-limitations">Summary and Limitations<a class="anchor" aria-label="anchor" href="#summary-and-limitations"></a>
</h2>
<p>The  package can be used to estimate mortality differentials without population denominators. A few limitations to this approach:</p>
<ol style="list-style-type: decimal">
<li><p>The Gompertz law does not apply perfectly to any application, and major departures from either assumption may bias estimates.</p></li>
<li><p>This approach assumes proportional hazards: the survival curves for different strata have hazard functions that are proportional over time.</p></li>
<li><p>The computational demands of this approach are intensive, and the <code>gompert_mle()</code> function runs into computational challenges when there are many parameters (e.g., models that have family fixed-effects).</p></li>
<li><p>The sample distribution of available deaths must be representative of the population distribution of deaths.</p></li>
</ol>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Casey Breen, Maria Osborne, Joshua R. Goldstein.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.2.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
