---
title: "Analyzing doubly-truncated mortality data using the gompertztrunc package"
author: Casey Breen (caseybreen@berkeley.edu)
output: 
  rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Analyzing doubly-truncated mortality data using the gompertztrunc package}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
nocite: '@*'
editor_options: 
  markdown: 
    wrap: 72
    number_sections: true
---

## Introduction 

Researchers increasingly have access to administrative mortality records that only include those who have died for a limited observation window without information on survivors. The double truncation and absence of denominators precludes the use of conventional tools of survival analysis. 

The **gompertztrunc** package includes tools for mortality estimation doubly-truncated datasets without population denominators.  

## Summary of Parametric Gompertz Approach 

This method assumes mortality follows a parametric model Gompertz model and uses maximum likelihood methods to estimate the underlying mortality distribution. Specifically, the hazard for individual $i$ at age $x$ given parameters $\beta$ is given by 

$$h_i(x | \beta) = a_0 e^{b_0 x} e^{\beta Z_i}$$ 
where

- $h(x)$ is the hazard at age $x$ 
- $a_0$ is some baseline level of mortality 
- $b_0$ gives rate of increase of mortality 
- $Z_i$ are the covariates for person $i$ (e.g., years of education, place of birth) 
- $\beta$ is the set of parameters


The model will estimate the values of $\widehat{a}$, $\widehat{b}$, and $\widehat{\beta}$. 

The main function in the package is the `gompertztrunc::gompertz_mle` function, which takes the following arguments: 

- `formula`: model formula (for example, death_age ~ educ_yrs + homeownership)

- `left_trunc`: year of upper truncation 

- `right_trunc`: year of lower truncation 

- `data`: data frame with age of death variable and covariates 

- `byear`: year of birth 

- `maxiter` maximum number of iteration for [optim](https://www.rdocumentation.org/packages/stats/versions/3.6.2/topics/optim) function  

- `weights` a person-level weight 

## Setup 

First, we load the **gompertztrunc** package from Github. 

```{r, eval = F}
## install gompertztrunc package from Github
install.packages("devtools")
devtools::install_github("caseybreen/gompertztrunc")
```


```{r, warning=FALSE, results='hide',message=FALSE}
## library packages
library(gompertztrunc)         ## calculate mortality differentials under double-truncation  
library(tidyverse)             ## data manipulation and visualization  
library(data.table)            ## fast data manipulation
library(cowplot)               ## publication-ready themes for ggplot
library(socviz)                ## helper functions for data visualization (Kieran Healy)  
library(tictoc)                ## functions for timing r scripts 
library(broom)                 ## "tidy" model output 


## load data 
sim_data <- sim_data           ## simulated 
bunmd_demo <- bunmd_demo       ## real 
```

## Case Study I: Simulated Data

In our first case study, we use simulated (fake) data included in the Gompertztrunc package. Because we simulated the data, we know the true coefficient values (we also know that the mortality follows a Gomeprtz ditsribution and our proportional hazards assumption holds). 

```{r}
## Look at simulated data 
head(sim_data)

## What years do we have mortality coverage? 
sim_data %>% 
  summarize(min(dyear), max(dyear)) 
```

Now let's try running `gompertz_mle()` function on the simulated data: 

```{r}
## run gompertz_mle function  
## returns a list 
simulated_example <- gompertztrunc::gompertz_mle(formula = aod ~ temp + as.factor(sex) + isSouth,
                                                 left_trunc = 1888,
                                                 right_trunc = 1905,
                                                 data = sim_data)
```



The \code{gompertz\_mle} function returns a list which contains three elements:

1. The initial starting parameters for the MLE routine. These starting parameter are found using linear regression on age at death

2. The full \code{optim} object, which gives details of the optimization routine (e.g., whether the model converged)

3. A data.frame of containing estimated Gompertz parameters, coefficients, and hazards ratios with 95\% confidence intervals.  

We recommend always checking the full \code{optim} object to make sure the model has converged. 


```{r}
## 1. starting value for coefficients (from linear regression)
simulated_example$starting_values

## 2. optim fit object
simulated_example$optim_fit

## 2. check model convergence (0 == convergence)
simulated_example$optim_fit$convergence

## 3. Look at model results 
simulated_example$results
```

The first column gives the Gompertz $b$ parameter, and the second row gives the Gompertz mode.

```{r}
## true coefficient values (we know bc we simulated them)
mycoefs <- c("temp" = +.2, "sex" = -.5, "isSouth" = +.6)

## compare our estimated values to true value 
## we can only do this because this is simulated (fake) data 

simulated_example$results %>%
  filter(!stringr::str_detect(parameter, "gompertz")) %>%
  mutate(true_coef = mycoefs) %>%
  select(parameter, coef, coef_lower, coef_upper, true_coef)
```

Many investigators will ultimately report hazard ratios. However, translating hazard ratios into difference in life expectancy may help facilitate interpretation and comparison to other studies.  

```{r}
## translate hazard rates to difference in e65
convert_hazards_to_ex(simulated_example$results, age = 65) %>% 
  select(parameter, e65, e65_lower, e65_upper)
```

## Case Study II: Real-World Example with BUNMD Data 

In our second case study, we look at the mortality advantage for the foreign-born. 

```{r}
## look at data 
head(bunmd_demo)

## how many people per country? 
bunmd_demo %>%
  count(bpl_string)
```
First, let's look at the distribution of deaths by country: 

```{r, fig.width = 6, fig.height = 4}
## distribution of deaths?
ggplot(data = bunmd_demo) + 
  geom_density(aes(x = death_age),
                 fill = "grey",
                 color = "black",
                 binwidth = 1) + 
  cowplot::theme_cowplot() + 
  labs(x = "Age of Death",
       y = "Density") + 
  facet_wrap(~bpl_string)
```


### Linear regression apporach 

Let's look at the association between country of origin and longevity. First, we'll try using our old approach (linear regression on age of death). 

```{r}
## run linear model 
lm_bpl <- lm(death_age ~ bpl_string + as.factor(byear), data = bunmd_demo)

## extract coefficients from model 
lm_bpl_tidy <- tidy(lm_bpl) %>%
  filter(str_detect(term, "bpl_string")) %>%
  mutate(term = prefix_strip(term, "bpl_string"))

## rename variables 
lm_bpl_tidy <- lm_bpl_tidy %>%
  mutate(
    e65 = estimate,
    e65_lower = estimate - 1.96 * std.error,
    e65_upper = estimate + 1.96 * std.error
  ) %>%
  rename(country = term) %>%
  mutate(method = "Regression on Age of Death")
```

Now, we'll try our new Gompertz MLE parametric approach: 

```{r}
## Gompertz Trunc 
## Use 1988-2005 because we are using BUNMD 
gompert_mle_results <- gompertz_mle(formula = death_age ~ bpl_string, 
                                    left_trunc = 1988,
                                    right_trunc = 2005,
                                    data = bunmd_demo)

## convert to e65
## use model estimates — but can also set other defaults for Gompertz M and B. 
mle_results <- convert_hazards_to_ex(gompert_mle_results$results, use_model_estimates = T)

## tidy up results 
mle_results <- mle_results %>% 
  rename(country = parameter) %>%
  filter(str_detect(country, "bpl_string")) %>%
  mutate(country = prefix_strip(country, "bpl_string")) %>%
  mutate(method = "Gompertz Parametric Estimate")

## look at results 
mle_results
```

### Visualize Results 

Compare our estimates from 'unbiased' Gompertz MLE method and our old 'biased' method, regression on age of death. 

```{r, fig.width = 7.2, fig.height = 5}
## combine results from both models 
bpl_results <- lm_bpl_tidy %>%
  bind_rows(mle_results)

## Calculate adjustment factor (i.e., how much bigger are Gompertz MLE results)
adjustment_factor <- bpl_results %>% 
  select(country, method, e65) %>%
  pivot_wider(names_from = method, values_from = e65) %>%
  mutate(adjustment_factor = `Gompertz Parametric Estimate` / `Regression on Age of Death`) %>%
  summarize(adjustment_factor_mean = round(mean(adjustment_factor), 3)) %>%
  as.vector()

## Plot results
bpl_results %>%
  bind_rows(mle_results) %>%
  ggplot(aes(y = reorder(country, e65), x = e65, xmin = e65_lower, xmax = e65_upper, color = method)) +
  geom_pointrange(position = position_dodge(width = 0.2), shape = 1) +
  cowplot::theme_cowplot(font_size = 12) +
  geom_vline(xintercept = 0, linetype = "dashed") +
  theme(legend.position = "bottom", legend.title = element_blank()) +
  labs(
    x = "Estimate",
    title = "Foreign-Born Male Ages at Death, BUNMD 1905-1914",
    y = "",
    subtitle = paste0("Gompertz MLE estimates are ~", adjustment_factor, " times larger than regression on age of death")
  ) +
  scale_color_brewer(palette = "Set1") +
  annotate("text", label = "Native Born Whites", x = 0.1, y = 3, angle = 90, size = 3, color = "black")
```

<!-- ## Add another covariate  -->

<!-- Let's another covariate to the model: age at first Social Security application. Why is this interesting?  -->

<!-- ```{r, fig.width = 8, fig.height = 4} -->
<!-- ## age first application by country -->
<!-- bunmd_demo %>% -->
<!--   ggplot() + -->
<!--   geom_density(aes(x = age_first_application), -->
<!--     fill = "grey", -->
<!--     color = "black" -->
<!--   ) + -->
<!--   facet_wrap(~bpl_string) +  -->
<!--   cowplot::theme_cowplot() -->
<!-- ``` -->

<!-- ```{r, eval = F} -->
<!-- ## now add a covariate   -->
<!-- gompert_mle_results_cov <- gompertz_mle(formula = death_age ~ bpl_string + age_first_application,  -->
<!--                                     left_trunc = 1988, -->
<!--                                     right_trunc = 2005, -->
<!--                                     data = bunmd_demo) -->


<!-- ## convert to e65 -->
<!-- ## here, we use model estimates. but can also set other defaults for Gomperz M and B.  -->
<!-- mle_results <- convert_hazards_to_ex(gompert_mle_results_cov$results, use_model_estimates = T) -->
<!-- ``` -->


## Case Study III: Education and longevity

In our third case study, we look at the association between education homeownership.  

```{r}
## load in file 
dmf_demo <- censoc_example

## what's in the file? 
head(dmf_demo)
```

In the CenSoc-DMF demo dataset, have three covariates: 

- `educ_yrs`: years of education 
- `urban`: urban (1) vs. rural (0)
- `ownhome`: own home (1) rented or N/A (0)

**Questions:** 

1. What's the association between a 1-year increase in education and life expectancy at 65 (e65)? 
2. Do people who own homes live longer than those who rent? 

```{r, eval = F}
## Example with only one cohort
education_gradient <- gompertz_mle(formula = death_age ~ educ_yrs, 
                                   data = dmf_demo,
                                   left_trunc = 1975 , 
                                   right_trunc = 2005)

## look at results 
education_gradient$results 

## look at effect on e65
convert_hazards_to_ex(education_gradient$results, use_model_estimates = T)
```
Here, for every additional year of education, the hazard ratio falls by 3.6\%. 

```{r, eval = F}
## Example with only one cohort
home_ownership <- gompertz_mle(formula = death_age ~ ownhome, 
                                   data = dmf_demo,
                                   left_trunc = 1975 , 
                                   right_trunc = 2005)

## look at results 
home_ownership$results 

## look at effect on e65
convert_hazards_to_ex(home_ownership$results, use_model_estimates = T)
```

## Person-weights 

The Gompertztrunc package can incorporate person-level weights.The weight for each person corresponds to the estimated number of persons in the target population that person represents. Weights can help adjust for differential representation. 

The vector of supplied weights must be long as the data, and all weights must be positive. 

In this example, we will simulate person-level weights. Imagine our data was perfectly representative of our population of interest (men born in 1910 dying in our doubly truncated window of 1975-2005) with one exception: people who rented in 1940 and died after the the age of 90 were were only half as likely to be included in our dataset. To adjust for this, we can assign each person who rented in 1940 and died after the age of 90 a weight of 2 and everyone else in the dataset a weight of 1. 


How will the new weights change our substantive conclusions? 

```{r}
## Simulate weights 
dmf_demo <- dmf_demo %>% 
  mutate(pweight = case_when(
    death_age > 90 & ownhome == 0 ~ 2,
    TRUE ~ 1
  ))

## Run model without weights 
homeownership_model <- gompertz_mle(formula = death_age ~ ownhome, 
                                   data = dmf_demo,
                                   left_trunc = 1975 , 
                                   right_trunc = 2005)

## Rerun with weights 
homeownership_model_weighted <- gompertz_mle(formula = death_age ~ ownhome, 
                                   data = dmf_demo,
                                   left_trunc = 1975, 
                                   right_trunc = 2005,
                                   weight = pweight)


## Looks at results 
homeownership_model$results 

## Looks at weighted results 
homeownership_model_weighted$results 
```
Using our new weights, we see that owning a home no longer is now associated with *higher* mortality rather than *lower* mortality. This matches our prior, as the we effectively added lots of people dying at very old ages who did not own homes. 


## Summary and Limitations 

The \textbf{gompertztrunc} package can be used to estimate mortality differentials without population denominators. A few limitations to this approach: 


1. The Gompertz law does not apply perfectly to any application, and major departures from either assumption may bias estimates. 

2. This approach generally requires larger sample sizes to produce reliable estimates.

3. This approach assumes proportional hazards: the survival curves for different strata have hazard functions that are proportional over time. 

<!-- ## Confidence Interval Coverage Rate  -->

<!-- Recall the definition of a confidence interval — a confidence interval represents the long-run frequency that a confidence interval contains the true value of the unknown parameter.  -->

<!-- We can assess the coverage ratio of our confidence intervals by repeating the following procedure many times: (1) simulate new data; (2) estimating 95% confidence intervals for coefficients; (3) checking whether our 95% confidence intervals for a parameter should contain the true parameter value. -->

<!-- A 95% confidence interval should in the long run have a coverage ratio of 95%. That is, approximately 95% of the confidence intervals should contain the true value.  -->

<!-- ```{r, eval = F} -->
<!-- ## create list for storing our results  -->
<!-- confidence_interval <- list() -->

<!-- ## rerun our experiment 100 times  -->

<!-- for (i in 1:1000) { -->

<!--   ## we simulate without any cohort distinctions -->
<!--   myform <- formula(aod ~ temp + sex + isSouth) -->
<!--   mycoefs <- c("temp" = +.2, "sex" = -.5, "isSouth" = +.7) -->

<!--   n <- 10000 -->

<!--   data <- gompertztrunc_simu( -->
<!--     n = n, -->
<!--     formula = myform, -->
<!--     coefs = mycoefs, -->
<!--     dummy = c(F, T, T), -->
<!--     sigma = c(3, 1, 1) -->
<!--   ) -->
<!--   ## now we structure into multiple cohorts -->
<!--   byear.vec <- 1810:1819 ## multiple birth cohorts -->
<!--   dyear.vec <- 1888:1905 ## a limited window of observations -->
<!--   min.age <- 65 ## only observe those 65+ -->

<!--   data[, byear := rep(byear.vec, rep(n / length(byear.vec), length(byear.vec)))] -->

<!--   ## pretend dates of birth within year are uniform -->
<!--   data[, dob := byear + runif(length(byear))] -->

<!--   ## date of death = date of birth + age of death -->
<!--   data[, dod := dob + aod] -->

<!--   ## y.left for each person -->
<!--   data[, y.left := min(dyear.vec) - floor(byear)] -->
<!--   ## only 65+ -->
<!--   data[y.left < 65, y.left := 65] -->
<!--   ## y.right for each person -->
<!--   data[, y.right := max(dyear.vec) - floor(byear)] -->

<!--   ## artificially truncate -->
<!--   data.trunc <- data[y.left <= aod & aod < y.right] -->

<!--   gompertmle <- gompertztrunc::gompertz_mle(formula = aod ~ temp + sex + isSouth, data = data.trunc, left_trunc = 1888, right_trunc = 1905) -->

<!--   results <- gompertmle$results %>% -->
<!--     dplyr::filter(!stringr::str_detect(parameter, "gompertz")) %>% -->
<!--     mutate(true_value = mycoefs) %>% -->
<!--     select(parameter, coef, coef_lower, coef_upper, true_value) %>% -->
<!--     mutate(ci_capture = case_when( -->
<!--       true_value > coef_lower & true_value < coef_upper ~ 1, -->
<!--       TRUE ~ 0 -->
<!--     )) -->

<!--   ## print simulation  -->
<!--   cat(i, " ") -->

<!--   confidence_interval[[i]] <- results -->
<!-- } -->

<!-- ## put results into on data.frame  -->
<!-- confidence_interval_coverage <- bind_rows(confidence_interval) -->

<!-- ## What's the coverage ratio of our confidence intervals?  -->
<!-- confidence_interval_coverage %>% -->
<!--   group_by(parameter) %>% -->
<!--   summarize(ci_coverage = mean(ci_capture)) -->
<!-- ``` -->



