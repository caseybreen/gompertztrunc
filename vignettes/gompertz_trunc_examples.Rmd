---
title: "Gompertztrunc Demonstration"
output: html_notebook
---


The main function in the package is the `gompertztrunc::gompertz_mle`. It estimates truncated gompertz. 

The `gompertztrunc::gompertz_mle` function takes the following arguments: 

- `fml`: = formula (death_age ~ educ_yrs + homeownership)

- `left_trunc`: year of upper truncation 

- `right_trunc``: year of lower truncation 

- `data`: dataframe with age of death and covariates 

A few other notes: 

(1) I round death age in these examples (round within our function) and still seem to work OK. 

(2) The function can now handle factors (e.g., formula = death_age ~ as.factor(educ_yrs))

(3) CenSoc datasets are available on the demography server under: /data/josh/CenSoc/censoc_data/


```{r}
library(tidyverse)
library(data.table)
library(tictoc)
```


## Example 1 

```{r}
## simulate data 
myform <- formula(aod ~ temp + isSouth)
mycoefs_example1 <- c("temp" = +.2, "isSouth" = +.6)

simulated_data1 <- tgm_simu(n = 10000,
                 form = myform,
                 coefs = mycoefs_example1,
                 dummy = c(F, T),
                 sigma = c(3, 1),
                 seed = 13)

## now we structure into multiple cohorts
simulated_data1[,byear := 1815] ## multiple birth cohorts

## run basic example 
tic()
results_example1 <- gompertztrunc::gompertz_mle(fml = aod ~ temp + isSouth, data = simulated_data1, left_trunc = 1888, right_trunc = 1905)
toc()

## compare to true value
results_example1 %>% 
   dplyr::filter(!stringr::str_detect(parameter, "gompertz")) %>%
  mutate(true_value = mycoefs_example1) %>% 
  select(parameter, coef, coef_lower, coef_upper, true_value)
```

## Example 2 

```{r}
## we simulate without any cohort distinctions
myform <- formula(aod ~ temp + sex + isSouth + sex:isSouth)
mycoefs <- c("temp" = +.2, "sex" = -.5, "isSouth" = +.6,
             "sex:isSouth" = +.3)
n = 100000
data <- tgm_simu(n = n,
                 form = myform,
                 coefs = mycoefs,
                 dummy = c(F, T, T, T),
                 sigma = c(3, 1, 1, 1),
                 seed = 14)
## now we structure into multiple cohorts
byear.vec <- 1810:1819 ## multiple birth cohorts
dyear.vec <- 1888:1905 ## a limited window of observations
min.age <- 65 ## only observe those 65+

data[, byear := rep(byear.vec, rep(n/length(byear.vec), length(byear.vec)))]
## pretend dates of birth within year are uniform
data[, dob := byear + runif(length(byear))]
## date of death = date of birth + age of death
data[, dod := dob + aod]

## y.left for each person
data[, y.left := min(dyear.vec) - floor(byear)]
## only 65+
data[y.left < 65, y.left := 65]
## y.right for each person
data[, y.right := max(dyear.vec) - floor(byear)]

## artificially truncate
data.trunc <- data[y.left <= aod & aod < y.right]
## check to see if dyear is correct
data.trunc[, range(floor(dod))]
## [1] 1888 1905, ok.

## Josh's tgm function (similar to gompertztrunc::gompertz_mle)
fit <- tgm(formula = myform, data = data.trunc, wt = NULL)

my_summary <- tgm_summary(fit,
                          true.coef.values = mycoefs)
## [1] "nobs: 20956"
print(round(my_summary,2))
##               est lower upper  true
## log.b.start -2.30 -2.30 -2.29 -2.30
## b0.start    -9.23 -9.23 -9.23 -9.21
## temp         0.20  0.19  0.21  0.20
## sex         -0.54 -0.56 -0.51 -0.50
## isSouth      0.52  0.43  0.61  0.60
## sex:isSouth  0.42  0.31  0.52  0.30

tic()
results_example2 <- gompertztrunc::gompertz_mle(fml = aod ~ temp + sex + isSouth + sex:isSouth, data = data.trunc, left_trunc = 1888, right_trunc = 1905)
toc()
```


## Example 3 

A simple example using a small extract from the CenSoc-DMF (cohort of 1910).

```{r}
## Example with only one cohort
tic()
education_gradient <- gompertz_mle(fml = death_age ~ educ_yrs, data = censoc_example, left_trunc = 1975, right_trunc = 2005)
toc()

## convert hazard ratios into e65 
## this is similar to what literature finds for education gradient (0.35) 
## similar answer if we exponentiate 
gompertztrunc::convert_hazard_ratio_to_le(hr = 0.9637085805, lower = 55, upper = 120, M = 80, beta = 0.1)
```


