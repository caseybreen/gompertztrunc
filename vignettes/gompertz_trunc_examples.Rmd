---
title: "Gompertztrunc Demonstration"
output: html_notebook
---


The main function in the package is the `gompertztrunc::gompertz_mle`. It estimates truncated gompertz. 

The `gompertztrunc::gompertz_mle` function takes the following arguments: 

- `fml`: = formula (death_age ~ educ_yrs + homeownership)

- `upper`: year of upper truncation 

- `lower`: year of lower truncation 

- `data`: dataframe with age of death and covariates 

A few other notes: 

(1) I round death age in these examples (round within our function) and still seem to work OK. 

(2) The function can now handle factors (e.g., formula = death_age ~ as.factor(educ_yrs))

(3) CenSoc datasets are available on the demography server under: /data/josh/CenSoc/censoc_data/


```{r}
library(tidyverse)
library(data.table)
library(tictoc)
```


## Example 1 

```{r}
## simulate data 
myform <- formula(aod ~ temp + isSouth)
mycoefs_example1 <- c("temp" = +.2, "isSouth" = +.6)
simulated_data1 <- tgm_simu(n = 10000,
                 form = myform,
                 coefs = mycoefs_example1,
                 dummy = c(F, T),
                 sigma = c(3, 1),
                 seed = 13)
## now we structure into multiple cohorts
simulated_data1[,byear := 1815] ## multiple birth cohorts

## run basic example 
tic()
results_example1 <- gompertztrunc::gompertz_mle(fml = aod ~ temp + isSouth, data = simulated_data1, lower = 1888, upper = 1905)
toc()

## function returns hazard ratios so we will take log 
## compare to true value
results_example1 %>% 
   dplyr::filter(!stringr::str_detect(parameter, "start")) %>%
    mutate(value = log(value),
           lower = log(lower),
           upper = log(upper)
           ) %>% 
  mutate(true_value = mycoefs_example1)
```

## Example 2 

```{r}
## we simulate without any cohort distinctions
myform <- formula(aod ~ temp + sex + isSouth + sex:isSouth)
mycoefs_example2 <- c("temp" = +.2, "sex" = -.5, "isSouth" = +.6,
             "sex:isSouth" = +.3)
n = 200000
data <- tgm_simu(n = n,
                 form = myform,
                 coefs = mycoefs_example2,
                 dummy = c(F, T, T, T),
                 sigma = c(3, 1, 1, 1),
                 seed = 14)
## now we structure into multiple cohorts
byear.vec <- 1815 ## multiple birth cohorts
dyear.vec <- 1888:1905 ## a limited window of observations
min.age <- 65 ## only observe those 65+

data[, byear := rep(byear.vec, rep(n/length(byear.vec), length(byear.vec)))]
## pretend dates of birth within year are uniform
data[, dob := byear + runif(length(byear))]
## date of death = date of birth + age of death
data[, dod := dob + aod]

## y.left for each person
data[, y.left := min(dyear.vec) - floor(byear)]
## only 65+
data[y.left < 65, y.left := 65]
## y.right for each person
data[, y.right := max(dyear.vec) - floor(byear)]

## artificially truncate
data.trunc <- data[y.left <= aod & aod < y.right]


```


```{r}
## filter to end points 
data.trunc <- data.trunc %>% 
  # mutate(aod = round(aod)) %>% 
  filter(dod >  1888 & dod < 1905)

tic()
results_example2 <- gompertztrunc::gompertz_mle(fml = aod ~ temp + sex + isSouth + sex:isSouth, data = data.trunc, lower = 1888, upper = 1905)
toc()

## convert hazard ratios back to parameters 
results_example2 %>% 
   dplyr::filter(!stringr::str_detect(parameter, "start")) %>%
    mutate(value = log(value),
           lower = log(lower),
           upper = log(upper),
           true_value = mycoefs_example2)

```

## Example 3 

A simple example using a small extract from the CenSoc-DMF (cohort of 1910).

```{r}
## Example with only one cohort

tic()
education_gradient <- gompertz_mle(fml = death_age ~ educ_yrs, data = censoc_example, lower = 1975, upper = 2005)
toc()

## convert hazard ratios into e65 
## this is similar to what literature finds for education gradient (0.3-04)
gompertztrunc::convert_hazard_ratio_to_le(hr = 0.96, lower = 55, upper = 120, M = 80, beta = 0.1)
```

```{r}
## seems to work fine for factors, just a little slow 
education_staircase <- gompertz_mle(fml = death_age ~ as.factor(educ_yrs), data = censoc_example, lower = 1975, upper = 2005)

education_staircase
```
## Josh's to-do list 


1:  The formulas I use don't account for factors, instead requiring
all variables to being either continuous or 0/1. I'm sure
there's a way to make this work more directly and to use factors
but this requires understanding model.matrix() and such better
than I do.

- I think this should work now â€” see example with education "staircase." 

2: apply to real data (e.g., BUNMD) or one of Censoc datasets

- Seems to work okay on very simple DMF dataset. I'm curious how it will work on BUNMD or Numident. 

3:  Check if weights are being used correctly in likelihood function 

4:  check if CI is correct 

- Agree this is important. I think the confidence intervals are probably anti-conservative; the coverage ratio of the 95% intervals is probably closer to 70% (if everything is working well). 

5:  include case where we see death_age as whole numbers, not continuous.

- I think this code works OK with whole numbers. (The examples in my vignette are all whole numbers.) 

6:  include way to specify struture of "beta", e.g. different for men and women, or smooth function of cohort or ... 


