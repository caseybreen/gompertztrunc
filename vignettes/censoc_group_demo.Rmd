---
title: "Analyzing doubly-truncated mortality data using the gompertztrunc package"
author: Casey Breen (caseybreen@berkeley.edu)
output: 
  rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Analyzing doubly-truncated mortality data using the gompertztrunc package}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
nocite: '@*'
editor_options: 
  markdown: 
    wrap: 72
    number_sections: true
---

## Introduction 

The **gompertztrunc** package includes tools for mortality estimation with CenSoc and other doubly-truncated data. 

## Summary of method 

The main function in the package is the `gompertztrunc::gompertz_mle`. It estimates 

The `gompertztrunc::gompertz_mle` function takes the following arguments: 

- `fml`: = formula (for example, death_age ~ educ_yrs + homeownership)

- `left_trunc`: year of upper truncation 

- `right_trunc``: year of lower truncation 

- `data`: data frame with age of death variable and covariates 


```{r, silent = T}
## library packages 
library(gompertztrunc)
library(tidyverse)
library(data.table)
library(tictoc)
```


## Simulate Mortality Data  

```{r}
## simulate data 
myform <- formula(aod ~ temp + isSouth)
mycoefs_example1 <- c("temp" = +.2, "isSouth" = +.6)

## simulate a dist
simulated_data1 <- gompertztrunc_simu(n = 10000,
                 form = myform,
                 coefs = mycoefs_example1,
                 dummy = c(F, T),
                 sigma = c(3, 1),
                 seed = 13)

## now we structure into multiple cohorts
simulated_data1[,byear := 1815] ## multiple birth cohorts
```

```{r}
## run basic example 
results_example1 <- gompertz_mle(fml = aod ~ temp + isSouth, data = simulated_data1, left_trunc = 1888, right_trunc = 1905)

## compare to true value
results_example1 %>% 
  dplyr::filter(!stringr::str_detect(parameter, "gompertz")) %>%
  mutate(true_value = mycoefs_example1) %>% 
  select(parameter, coef, coef_lower, coef_upper, true_value)
```

## Discrete Death Ages 

```{r}
## discrete ages 
simulated_data1 <- simulated_data1 %>% 
  mutate(aod = floor(aod))

results_example1_floor <- gompertztrunc::gompertz_mle(fml = aod ~ temp + isSouth, data = simulated_data1, left_trunc = 1888, right_trunc = 1905)

## compare to true value
results_example1_floor %>% 
  dplyr::filter(!stringr::str_detect(parameter, "gompertz")) %>%
  mutate(true_value = mycoefs_example1) %>% 
  select(parameter, coef, coef_lower, coef_upper, true_value)
```



## Example 2 

```{r}
## we simulate without any cohort distinctions
myform <- formula(aod ~ temp + sex + isSouth + sex:isSouth)
mycoefs <- c("temp" = +.2, "sex" = -.5, "isSouth" = +.6,
             "sex:isSouth" = +.3)
n = 30000
data <- gompertztrunc_simu(n = n,
                 form = myform,
                 coefs = mycoefs,
                 dummy = c(F, T, T, T),
                 sigma = c(3, 1, 1, 1),
                 seed = 14)
## now we structure into multiple cohorts
byear.vec <- 1810:1819 ## multiple birth cohorts
dyear.vec <- 1888:1905 ## a limited window of observations
min.age <- 65 ## only observe those 65+

data[, byear := rep(byear.vec, rep(n/length(byear.vec), length(byear.vec)))]
## pretend dates of birth within year are uniform
data[, dob := byear + runif(length(byear))]
## date of death = date of birth + age of death
data[, dod := dob + aod]

## y.left for each person
data[, y.left := min(dyear.vec) - floor(byear)]
## only 65+
data[y.left < 65, y.left := 65]
## y.right for each person
data[, y.right := max(dyear.vec) - floor(byear)]

## artificially truncate
data.trunc <- data[y.left <= aod & aod < y.right]
## check to see if dyear is correct
data.trunc[, range(floor(dod))]
## [1] 1888 1905, ok.

## Josh's tgm function (similar to gompertztrunc::gompertz_mle)
fit <- tgm(formula = myform, data = data.trunc, wt = NULL)

my_summary <- tgm_summary(fit,
                          true.coef.values = mycoefs)
## [1] "nobs: 20956"
print(round(my_summary,2))

results_example2 <- gompertztrunc::gompertz_mle(fml = aod ~ temp + sex + isSouth + sex:isSouth, data = data.trunc, left_trunc = 1888, right_trunc = 1905)

results_example2
```


## Example 3 

A simple example using a small extract from the CenSoc-DMF (cohort of 1910).

```{r}
## Example with only one cohort
education_gradient <- gompertz_mle(fml = death_age ~ educ_yrs, data = censoc_example, left_trunc = 1975, right_trunc = 2005)


education_gradient
```

```{r}
## convert hazard ratios into e65 
## similar answer if we exponentiate 
gompertztrunc::convert_hazard_ratio_to_le(hr = 0.9637085805, lower = 55, upper = 120, M = 80, beta = 0.1)
```


```{r, eval = F}
results <- list()

for (i in 1:300) {
  
  ## simulate data 
  myform <- formula(aod ~ temp + isSouth)
  mycoefs_example1 <- c("temp" = +.2, "isSouth" = +.6)
  
  simulated_data1 <- tgm_simu(n = 30000,
                              form = myform,
                              coefs = mycoefs_example1,
                              dummy = c(F, T),
                              sigma = c(3, 1))
  
  ## now we structure into multiple cohorts
  simulated_data1[,byear := 1815] ## multiple birth cohorts
  
  ## run basic example 
  tic()
  results_example1 <- gompertztrunc::gompertz_mle(fml = aod ~ temp + isSouth, data = simulated_data1, left_trunc = 1888, right_trunc = 1905)
  toc()
  
  ## compare to true value
  results_example1 <- results_example1 %>% 
    dplyr::filter(!stringr::str_detect(parameter, "gompertz")) %>%
    mutate(true_value = mycoefs_example1) %>% 
    select(parameter, coef, coef_lower, coef_upper, true_value) %>% 
    mutate(capture = case_when(
      true_value > coef_lower & true_value < coef_upper  ~ 1,
      TRUE ~ 0
    ))
  results[[i]] <- results_example1
}

test <- bind_rows(results)

test %>% 
  group_by(parameter) %>% 
  summarize(mean(capture))

test %>% 
  ggplot(aes(y = parameter, x = coef)) + 
  geom_density_ridges( jittered_points = TRUE,
    position = position_points_jitter(width = 0.05, height = 0),
    point_shape = '|', point_size = 3, point_alpha = 1, alpha = 0.7) + 
  cowplot::theme_cowplot()
```



```{r, eval = F}
results_interaction <- list()

for (i in 1:100) {
  
  ## we simulate without any cohort distinctions
  myform <- formula(aod ~ temp + sex + isSouth + sex:isSouth)
  mycoefs <- c("temp" = +.2, "sex" = -.5, "isSouth" = +.6,
               "sex:isSouth" = +.3)
  
  n <- 30000
  data <- gompertztrunc_simu(n = n,
                   form = myform,
                   coefs = mycoefs,
                   dummy = c(F, T, T, T),
                   sigma = c(3, 1, 1, 1))
  ## now we structure into multiple cohorts
  byear.vec <- 1810:1819 ## multiple birth cohorts
  dyear.vec <- 1888:1905 ## a limited window of observations
  min.age <- 65 ## only observe those 65+
  
  data[, byear := rep(byear.vec, rep(n/length(byear.vec), length(byear.vec)))]
  ## pretend dates of birth within year are uniform
  data[, dob := byear + runif(length(byear))]
  ## date of death = date of birth + age of death
  data[, dod := dob + aod]
  
  ## y.left for each person
  data[, y.left := min(dyear.vec) - floor(byear)]
  ## only 65+
  data[y.left < 65, y.left := 65]
  ## y.right for each person
  data[, y.right := max(dyear.vec) - floor(byear)]
  
  ## artificially truncate
  data.trunc <- data[y.left <= aod & aod < y.right]
  
  tic()
  results_example2 <- gompertztrunc::gompertz_mle(fml = aod ~ temp + sex + isSouth + sex:isSouth, data = data.trunc, left_trunc = 1888, right_trunc = 1905)
  toc()
  
    results_example2 <- results_example2 %>% 
    dplyr::filter(!stringr::str_detect(parameter, "gompertz")) %>%
    mutate(true_value = mycoefs) %>% 
    select(parameter, coef, coef_lower, coef_upper, true_value) %>% 
    mutate(capture = case_when(
      true_value > coef_lower & true_value < coef_upper  ~ 1,
      TRUE ~ 0
    ))
  
  results_interaction[[i]] <- results_example2
}

tes2 <- bind_rows(results_interaction)


tes2 %>% 
  group_by(parameter) %>% 
  summarize(mean(capture))
```


```{r, eval = F}
results_interaction <- list()

for (i in 1:500) {
  
  ## we simulate without any cohort distinctions
  myform <- formula(aod ~ temp + sex + isSouth )
  mycoefs <- c("temp" = +.08, "sex" = -.15, "isSouth" = +.26)
  
  n <- 10000
  
  data <- tgm_simu(n = n,
                   form = myform,
                   coefs = mycoefs,
                   dummy = c(F, T, T, T),
                   sigma = c(3, 1, 1, 1))
  ## now we structure into multiple cohorts
  byear.vec <- 1810:1819 ## multiple birth cohorts
  dyear.vec <- 1888:1905 ## a limited window of observations
  min.age <- 65 ## only observe those 65+
  
  data[, byear := rep(byear.vec, rep(n/length(byear.vec), length(byear.vec)))]
  ## pretend dates of birth within year are uniform
  data[, dob := byear + runif(length(byear))]
  ## date of death = date of birth + age of death
  data[, dod := dob + aod]
  
  ## y.left for each person
  data[, y.left := min(dyear.vec) - floor(byear)]
  ## only 65+
  data[y.left < 65, y.left := 65]
  ## y.right for each person
  data[, y.right := max(dyear.vec) - floor(byear)]
  
  ## artificially truncate
  data.trunc <- data[y.left <= aod & aod < y.right]
  
  tic()
  results_example2 <- gompertztrunc::gompertz_mle(fml = aod ~ temp + sex + isSouth, data = data.trunc, left_trunc = 1888, right_trunc = 1905)
  toc()
  
    results_example2 <- results_example2 %>% 
    dplyr::filter(!stringr::str_detect(parameter, "gompertz")) %>%
    mutate(true_value = mycoefs) %>% 
    select(parameter, coef, coef_lower, coef_upper, true_value) %>% 
    mutate(capture = case_when(
      true_value > coef_lower & true_value < coef_upper  ~ 1,
      TRUE ~ 0
    ))
  
  results_interaction[[i]] <- results_example2
}

tes2 <- bind_rows(results_interaction)

tes2 %>% 
  group_by(parameter) %>% 
  summarize(mean(capture))
```


